C51 COMPILER V6.12  DS18B20                                                                02/01/2012 12:28:39 PAGE 1   


C51 COMPILER V6.12, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN .\ds18b20.OBJ
COMPILER INVOKED BY: F:\软件\keil C\C51\BIN\C51.EXE .\ds18b20.c BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          ///无线模块板
   2          #include<reg52.h>
   3          #include<intrins.h>
   4          #define uchar unsigned char
   5          #define uint unsigned int
   6          sbit DQ=P2^0;			 //ds18b20
   7          // 1602
   8          sbit lcden=P3^7;
   9          sbit lcdrs=P3^4;
  10          sbit lcdrw=P3^6;
  11          sbit BELL=P1^6;
  12          uint wendu=0;
  13          ////////  12864
  14          void delay1ms(uint z)
  15          {
  16   1      	uint x,y;
  17   1      	for(x=z;x>0;x--)
  18   1      		for(y=114;y>0;y--);
  19   1      }
  20          
  21          void  write_com(uchar com)
  22          { 	
  23   1      	lcdrs=0;
  24   1      	P0=com;
  25   1      	delay1ms(1);
  26   1      	lcden=1;
  27   1      	delay1ms(1);
  28   1      	lcden=0;
  29   1      
  30   1      }
  31          void write_date(uchar date)
  32          {
  33   1      	lcdrs=1;
  34   1      	P0=date;
  35   1      	delay1ms(1);
  36   1      	lcden=1;
  37   1      	delay1ms(1);
  38   1      	lcden=0;
  39   1      }
  40          
  41          void write_str(uchar *str)  
  42          {  
  43   1       while(*str!='\0')  //未结束   
  44   1       {  
  45   2        write_date(*str++);  
  46   2        delay1ms(5);  
  47   2       }  
  48   1      } 
  49          
  50          void write_pos(uchar x,uchar y)  //从第X行的第Y位置开始显示   
  51          {  
  52   1       uchar pos;  
  53   1       if(x==1)        //第一行   
  54   1       { x=0x80;}  
  55   1       else if(x==2)  //第二行   
C51 COMPILER V6.12  DS18B20                                                                02/01/2012 12:28:39 PAGE 2   

  56   1       { x=0x90;}  
  57   1       else if(x==3)  //第三行   
  58   1       { x=0x88;}  
  59   1       else if(x==4)  //第四行   
  60   1       { x=0x98;}  
  61   1       pos=x+y-1;     //首地址为0X80   
  62   1       write_com(pos);  
  63   1      } 
  64          
  65          void init_12864()
  66          {	
  67   1      	lcdrw=0; 
  68   1      	lcden=0;
  69   1      	write_com(0x01);
  70   1      	delay1ms(5);
  71   1      	write_com(0x30);	
  72   1      	write_com(0x06);
  73   1      	write_com(0x0c);
  74   1      	write_com(0x88);
  75   1      	write_pos(1,1);
  76   1      	write_str("  温度测量实验");
  77   1      	write_pos(3,1);
  78   1      	write_str("当前温度:");
  79   1      	write_pos(3,8);
  80   1      	write_str("度");
  81   1      	write_pos(4,1);
  82   1      	write_str("顺通电子工作室");
  83   1      
  84   1      
  85   1      
  86   1      }
  87          /////	 ////			 ds18b20
  88          
  89          bit init_DS18B20()
  90          { 
  91   1      	uchar num;
  92   1      	bit flag;
  93   1      	DQ=1;
  94   1      	for(num=0;num<2;num++);  //先拉高
  95   1      	DQ=0;
  96   1      	for(num=0;num<200;num++);  // 480-960us	powerup
  97   1      	DQ=1;
  98   1      	for(num=0;num<20;num++);	//  >60us   wait
  99   1      	flag=DQ;					// 响应
 100   1      	for(num=0;num<150;num++);	//	 60-240us ds18b20存在信号
 101   1      	DQ=1;
 102   1      	return flag;
 103   1      }
 104          
 105          void DS18B20_WR_CHAR(uchar byte)	// 先写低位
 106          {	
 107   1      	uchar num;
 108   1      	uchar num1;
 109   1      	for(num1=0;num1<8;num1++)
 110   1      	{	 	
 111   2      		DQ=0;		//拉低
 112   2      		_nop_();	//下拉1us
 113   2      		_nop_();
 114   2      		DQ=byte&0x01;
 115   2      		for(num=0;num<20;num++);	//  >60us   wait
 116   2      		byte>>=1;	
 117   2      		DQ=1;	  //拉高	
C51 COMPILER V6.12  DS18B20                                                                02/01/2012 12:28:39 PAGE 3   

 118   2      		_nop_();
 119   2      		_nop_();
 120   2      	}		
 121   1      }
 122          
 123          uchar DS18B20_RD_CHAR()	//先读低位
 124          {
 125   1      	uchar num;
 126   1      	uchar num1;
 127   1      	uchar byte=0;
 128   1      	for(num1=0;num1<8;num1++)
 129   1      	{
 130   2      		DQ=0;  	//拉低
 131   2      		_nop_();
 132   2      		DQ=1;
 133   2      		for(num=0;num<1;num++);  // <10us 	
 134   2      		byte>>=1;
 135   2      		if(DQ==1)
 136   2      			byte|=0x80;
 137   2      		else 
 138   2      			byte|=0x00;
 139   2      		DQ=1;	//拉高
 140   2      		_nop_();
 141   2      		_nop_();
 142   2      		for(num=0;num<20;num++);  //  >60us
 143   2      		
 144   2      	}
 145   1      	return byte;
 146   1      }
 147          
 148          uint DS18B20_WENDU()
 149          {
 150   1      	uchar temperaturel=0,temperatureh=0;
 151   1      	uint temperature=0;
 152   1      	if(init_DS18B20()==0)
 153   1      	{
 154   2      		DS18B20_WR_CHAR(0xcc);
 155   2      		DS18B20_WR_CHAR(0x44);
 156   2      		delay1ms(1000);
 157   2      		if(init_DS18B20()==0)
 158   2      		{	
 159   3      			DS18B20_WR_CHAR(0xcc);
 160   3      			DS18B20_WR_CHAR(0xBE);
 161   3      			_nop_();
 162   3      			temperaturel=DS18B20_RD_CHAR();
 163   3      			temperatureh=DS18B20_RD_CHAR();
 164   3      			temperature=(temperatureh*256+temperaturel)*0.625;
 165   3      			init_DS18B20();
 166   3      		}
 167   2      		return temperature;				
 168   2      	}
 169   1      }
 170          
 171          ///////
 172          main()
 173          {
 174   1      	init_12864();
 175   1      	delay1ms(1000);
 176   1      	while(1)
 177   1      	{
 178   2      		if( init_DS18B20()==0)  	
 179   2           	{   
C51 COMPILER V6.12  DS18B20                                                                02/01/2012 12:28:39 PAGE 4   

 180   3      			wendu=DS18B20_WENDU();  
 181   3      			write_pos(3,6);
 182   3      			write_date((wendu/100)%10+48);
 183   3      			write_date((wendu/10)%10+48);
 184   3      			write_date('.');
 185   3      			write_date(wendu%10+48);
 186   3      			BELL=0;
 187   3      			delay1ms(1);
 188   3      			BELL=1;
 189   3      			delay1ms(2000);
 190   3      		}  
 191   2      	}
 192   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    534    ----
   CONSTANT SIZE    =     43    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2       5
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
